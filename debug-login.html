<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Debug - Digital Soko</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
    <h1 class="text-2xl font-bold mb-6">Login Debug Tool</h1>
    
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">Email</label>
        <input type="email" id="email" value="admin@example.com" 
               class="w-full border rounded px-3 py-2">
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Password</label>
        <input type="password" id="password" value="admin123" 
               class="w-full border rounded px-3 py-2">
      </div>
      
      <button onclick="testLogin()" 
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Test Login
      </button>
      
      <button onclick="testRawFetch()" 
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        Test Raw Fetch
      </button>
    </div>
    
    <div id="results" class="mt-6 p-4 bg-gray-50 rounded">
      <h3 class="font-semibold mb-2">Results will appear here...</h3>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script>
    const results = document.getElementById('results');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
      results.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
    }
    
    function clearResults() {
      results.innerHTML = '<h3 class="font-semibold mb-2">Results:</h3>';
    }
    
    async function testLogin() {
      clearResults();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      log(`Testing login with: ${email} / ${password}`);
      
      try {
        log('Calling authAPI.login...');
        const response = await authAPI.login({ email, password });
        
        log('✅ Login successful!', 'success');
        log(`Response: ${JSON.stringify(response, null, 2)}`);
        
        if (response.data?.token) {
          log('✅ Token received', 'success');
          log(`Token preview: ${response.data.token.substring(0, 50)}...`);
        }
        
        if (response.data?.user) {
          log('✅ User data received', 'success');
          log(`User: ${response.data.user.firstName} ${response.data.user.lastName} (${response.data.user.role})`);
        }
        
      } catch (error) {
        log('❌ Login failed!', 'error');
        log(`Error: ${error.message}`, 'error');
        log(`Full error: ${JSON.stringify(error, null, 2)}`, 'error');
      }
    }
    
    async function testRawFetch() {
      clearResults();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      log(`Testing raw fetch with: ${email} / ${password}`);
      
      try {
        log('Making raw fetch request...');
        
        const response = await fetch('http://localhost:5000/api/v1/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, password })
        });
        
        log(`Response status: ${response.status} ${response.statusText}`);
        log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
        
        const responseText = await response.text();
        log(`Raw response text: ${responseText}`);
        
        let data;
        try {
          data = JSON.parse(responseText);
          log(`Parsed JSON: ${JSON.stringify(data, null, 2)}`);
        } catch (parseError) {
          log(`JSON parse error: ${parseError.message}`, 'error');
          log(`Response was not valid JSON`, 'error');
          return;
        }
        
        if (response.ok) {
          log('✅ Raw fetch successful!', 'success');
          if (data.data?.token) {
            log('✅ Token received in response', 'success');
          }
        } else {
          log('❌ Raw fetch failed!', 'error');
        }
        
      } catch (error) {
        log('❌ Raw fetch error!', 'error');
        log(`Error: ${error.message}`, 'error');
        log(`Network error or server not running`, 'error');
      }
    }
    
    // Test API availability on load
    window.addEventListener('load', () => {
      log('Checking API availability...');
      
      if (typeof window.authAPI !== 'undefined') {
        log('✅ authAPI is available', 'success');
      } else {
        log('❌ authAPI is NOT available', 'error');
      }
      
      if (typeof window.api !== 'undefined') {
        log('✅ api client is available', 'success');
      } else {
        log('❌ api client is NOT available', 'error');
      }
    });
  </script>
</body>
</html>
