<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Soko ‚Äî Post Item</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/api.js?v=4"></script>
  <script src="js/price-checker.js"></script>
  <link rel="stylesheet" href="css/background-styles.css">
</head>
<body class="min-h-screen">
  <!-- Clear Background for authenticated pages -->
  <div class="soko-background clear">
    <div class="floating-elements"></div>
  </div>
  <!-- Navbar -->
  <header class="bg-blue-700 text-white">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-6 py-4">
      <div class="text-2xl font-bold">Digital Soko</div>

      <!-- Menu -->
      <div class="relative">
        <button id="menuBtn" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500 flex items-center gap-2">‚ò∞ Menu</button>
        <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white text-gray-800 rounded shadow-lg z-50">
          <a href="dashboard.html" class="block px-4 py-2 hover:bg-gray-100">üè† Dashboard</a>
          <a href="my-items.html" class="block px-4 py-2 hover:bg-gray-100">üì¶ My Items</a>
          <a href="post-item.html" class="block px-4 py-2 hover:bg-gray-100 font-bold">‚ûï Post Item</a>
          <a href="marketplace.html" class="block px-4 py-2 hover:bg-gray-100">üõí Marketplace</a>
          <a href="barter-requests.html" class="block px-4 py-2 hover:bg-gray-100">üîÑ Barter Requests</a>
          <a href="messages.html" class="block px-4 py-2 hover:bg-gray-100">üí¨ Messages</a>
          <a href="settings.html" class="block px-4 py-2 hover:bg-gray-100">‚öô Settings</a>
          <a href="admin-dashboard.html" class="block px-4 py-2 hover:bg-gray-100 bg-purple-50 text-purple-700 font-semibold">üõ°Ô∏è Admin Panel</a>
          <a href="login.html" class="block px-4 py-2 hover:bg-gray-100 text-red-600">üö™ Logout</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-6 py-8 content-overlay">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Post New Item</h1>

      <form id="postItemForm" class="bg-white p-6 rounded-lg shadow-md space-y-4 max-w-2xl">
        <div>
          <label class="block font-semibold mb-1">Item Name</label>
          <input type="text" id="itemName" required class="w-full border px-3 py-2 rounded"/>
        </div>

        <div>
          <label class="block font-semibold mb-1">Description</label>
          <textarea id="itemDesc" rows="3" class="w-full border px-3 py-2 rounded"></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">Category</label>
          <select id="itemCategory" required class="w-full border px-3 py-2 rounded">
            <option value="">-- Select Category --</option>
            <option value="Electronics">Electronics</option>
            <option value="Clothing">Clothing</option>
            <option value="Furniture">Furniture</option>
            <option value="Books">Books</option>
            <option value="Sports">Sports</option>
            <option value="Any">Any</option>
          </select>
        </div>

        <div>
          <label class="block font-semibold mb-1">Condition</label>
          <select id="itemCondition" required class="w-full border px-3 py-2 rounded">
            <option value="">-- Select Condition --</option>
            <option value="New">New</option>
            <option value="Like New">Like New</option>
            <option value="Used">Used</option>
            <option value="Fair">Fair</option>
            <option value="Any">Any</option>
          </select>
        </div>

        <div>
          <label class="block font-semibold mb-1">Price (Ksh)</label>
          <div class="flex gap-2">
            <input type="number" id="itemPrice" required min="0" class="flex-1 border px-3 py-2 rounded"/>
            <button type="button" id="checkPriceBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm whitespace-nowrap">
              ü§ñ Check Price
            </button>
          </div>
          <div id="priceAnalysis" class="hidden mt-2 p-3 rounded-lg border"></div>
        </div>

        <div>
          <label class="block font-semibold mb-1">Trade Type</label>
          <select id="itemTradeType" required class="w-full border px-3 py-2 rounded">
            <option value="">-- Select Trade Type --</option>
            <option value="FullAmount">Full Amount</option>
            <option value="TopUp">Top-up</option>
            <option value="Barter">Barter Only</option>
            <option value="Any">Any</option>
          </select>
        </div>

        <div>
          <label class="block font-semibold mb-1">Upload Image</label>
          <input type="file" id="itemImg" accept="image/*" class="w-full"/>
        </div>

        <div>
          <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            Post Item
          </button>
        </div>
      </form>
  </main>

  <!-- Success Modal -->
  <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-11/12 max-w-md text-center transform transition-all">
      <div class="mb-6">
        <div class="mx-auto w-20 h-20 bg-green-100 rounded-full flex items-center justify-center">
          <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">Success!</h3>
      <p id="successMessage" class="text-gray-600 mb-6">Your item has been posted successfully</p>
      <button onclick="closeSuccessModal()" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
        Continue
      </button>
    </div>
  </div>

  <script src="post-item.js"></script>
  <script>
    // Navbar dropdown toggle
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("menuBtn");
      const dropdown = document.getElementById("menuDropdown");
      btn.addEventListener("click", () => dropdown.classList.toggle("hidden"));
      document.addEventListener("click", (e) => {
        if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add("hidden");
        }
      });

      // Price checking functionality
      const checkPriceBtn = document.getElementById("checkPriceBtn");
      const priceAnalysisDiv = document.getElementById("priceAnalysis");

      checkPriceBtn.addEventListener("click", async () => {
        const itemName = document.getElementById("itemName").value;
        const itemCategory = document.getElementById("itemCategory").value;
        const itemCondition = document.getElementById("itemCondition").value;
        const itemPrice = parseFloat(document.getElementById("itemPrice").value);
        const itemDesc = document.getElementById("itemDesc").value;

        // Validate required fields
        if (!itemName || !itemCategory || !itemCondition || !itemPrice) {
          alert("Please fill in item name, category, condition, and price before checking.");
          return;
        }

        // Show loading state
        checkPriceBtn.disabled = true;
        checkPriceBtn.innerHTML = '‚è≥ Checking...';
        priceAnalysisDiv.classList.add("hidden");

        try {
          const item = {
            name: itemName,
            category: itemCategory,
            condition: itemCondition,
            price: itemPrice,
            description: itemDesc
          };

          const analysis = await window.priceChecker.checkPrice(item);
          displayPriceAnalysis(analysis);
        } catch (error) {
          console.error('Price check error:', error);
          displayPriceAnalysis({
            status: 'error',
            message: 'Unable to check price. Please ensure you have a valid Gemini API key configured.'
          });
        } finally {
          checkPriceBtn.disabled = false;
          checkPriceBtn.innerHTML = 'ü§ñ Check Price';
        }
      });

      function displayPriceAnalysis(analysis) {
        const priceAnalysisDiv = document.getElementById("priceAnalysis");
        
        if (analysis.status === 'error') {
          priceAnalysisDiv.className = "mt-2 p-3 rounded-lg border border-red-200 bg-red-50";
          priceAnalysisDiv.innerHTML = `
            <div class="text-red-800">
              <strong>‚ùå Error:</strong> ${analysis.message}
            </div>
          `;
        } else {
          const bgColor = {
            'fair': 'bg-green-50 border-green-200',
            'overpriced': 'bg-red-50 border-red-200',
            'underpriced': 'bg-blue-50 border-blue-200'
          }[analysis.assessment] || 'bg-gray-50 border-gray-200';

          const textColor = {
            'fair': 'text-green-800',
            'overpriced': 'text-red-800', 
            'underpriced': 'text-blue-800'
          }[analysis.assessment] || 'text-gray-800';

          const icon = {
            'fair': '‚úÖ',
            'overpriced': 'üìà',
            'underpriced': 'üìâ'
          }[analysis.assessment] || 'ü§î';

          const confidence = '‚≠ê'.repeat(Math.floor(analysis.confidence / 2));

          priceAnalysisDiv.className = `mt-2 p-3 rounded-lg border ${bgColor}`;
          priceAnalysisDiv.innerHTML = `
            <div class="${textColor}">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-lg">${icon}</span>
                <strong>${analysis.assessment.charAt(0).toUpperCase() + analysis.assessment.slice(1)} Price</strong>
                <span class="text-sm">${confidence} (${analysis.confidence}/10)</span>
              </div>
              <p class="mb-2">${analysis.message}</p>
              <div class="text-sm space-y-1">
                <div><strong>Market Range:</strong> KSH ${analysis.marketRange.min.toLocaleString()} - ${analysis.marketRange.max.toLocaleString()}</div>
                <div><strong>Suggested:</strong> KSH ${analysis.suggestedRange.min.toLocaleString()} - ${analysis.suggestedRange.max.toLocaleString()}</div>
                <div><strong>Reasoning:</strong> ${analysis.reasoning}</div>
              </div>
            </div>
          `;
        }
        
        priceAnalysisDiv.classList.remove("hidden");
      }
    });
  </script>
</body>
</html>
